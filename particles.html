<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hand-Controlled 3D Particle System - IKB</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000;
            overflow: hidden;
        }

        #canvas-container {
            width: 100vw;
            height: 100vh;
        }

        #video {
            display: none;
        }

        /* Camera Permission Overlay */
        .permission-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 200;
        }

        .permission-overlay.hidden {
            display: none;
        }

        .permission-content {
            text-align: center;
            color: white;
            max-width: 500px;
            padding: 40px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 20px;
            border: 2px solid rgba(102, 126, 234, 0.3);
        }

        .permission-content h1 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .permission-content p {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 30px;
            opacity: 0.9;
        }

        .start-btn {
            padding: 16px 40px;
            font-size: 18px;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
        }

        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.6);
        }

        .demo-note {
            margin-top: 20px;
            font-size: 0.9rem;
            opacity: 0.6;
        }

        /* Controls Panel */
        .controls {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 100;
            max-width: 300px;
        }

        .controls h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .mode-indicator {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .mode-indicator.camera {
            background: #d4edda;
            color: #155724;
        }

        .mode-indicator.demo {
            background: #fff3cd;
            color: #856404;
        }

        .gesture-info {
            background: rgba(102, 126, 234, 0.1);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .gesture-info p {
            color: #333;
            font-size: 0.85rem;
            margin-bottom: 5px;
        }

        .gesture-info strong {
            color: #667eea;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .control-group select {
            width: 100%;
            padding: 8px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-family: inherit;
        }

        .back-btn {
            display: block;
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 600;
            text-align: center;
            transition: opacity 0.3s;
        }

        .back-btn:hover {
            opacity: 0.9;
        }

        /* Video Preview */
        #video-preview {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 240px;
            height: 180px;
            border: 3px solid #667eea;
            border-radius: 12px;
            z-index: 50;
            transform: scaleX(-1);
            display: none;
        }

        #video-preview.active {
            display: block;
        }

        .top-label {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
            z-index: 10;
            opacity: 0.8;
        }

        @media (max-width: 768px) {
            .controls {
                left: 10px;
                right: 10px;
                max-width: none;
            }

            #video-preview {
                width: 160px;
                height: 120px;
                top: 10px;
                right: 10px;
            }

            .permission-content {
                padding: 20px;
            }

            .permission-content h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <video id="video" playsinline></video>
    <video id="video-preview" playsinline autoplay></video>
    <div class="top-label">‚úã Hand-Controlled Particle Universe</div>

    <!-- Permission Overlay -->
    <div class="permission-overlay" id="permissionOverlay">
        <div class="permission-content">
            <h1>üåü Interactive Particles</h1>
            <p>Experience a mesmerizing 3D particle system controlled by your hand gestures in real-time.</p>
            <button class="start-btn" id="startBtn">üöÄ Enable Camera & Start</button>
            <p class="demo-note">If camera is denied, a beautiful demo mode will run automatically.</p>
        </div>
    </div>

    <div id="canvas-container"></div>

    <div class="controls">
        <h2>üé® Particle Controls</h2>
        
        <div class="mode-indicator demo" id="modeIndicator">
            üé¨ Demo Mode Active
        </div>

        <div class="gesture-info">
            <p><strong>‚úã Open Hand:</strong> Firework explosion</p>
            <p><strong>‚úä Closed Hand:</strong> Heart shape</p>
            <p><strong>üëà Hand Left:</strong> Saturn rings</p>
            <p><strong>üëâ Hand Right:</strong> Flower pattern</p>
            <p><strong>üñêÔ∏è Hand Position:</strong> Controls rotation & color</p>
        </div>
        
        <div class="control-group">
            <label>Current Shape</label>
            <select id="shapeDisplay" disabled>
                <option value="heart">Heart ‚ù§Ô∏è</option>
                <option value="saturn">Saturn ü™ê</option>
                <option value="flower">Flower üå∏</option>
                <option value="firework">Firework üéÜ</option>
            </select>
        </div>

        <a href="projects.html" class="back-btn">‚Üê Back to Projects</a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.159.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

    <script>
        /* ==========================================
           THREE.JS SCENE SETUP
        ========================================== */
        const scene = new THREE.Scene();
        scene.fog = new THREE.Fog(0x000000, 20, 80);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.z = 30;

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        /* ==========================================
           PARTICLE SYSTEM
        ========================================== */
        const PARTICLE_COUNT = 6000;
        const geometry = new THREE.BufferGeometry();
        const positions = new Float32Array(PARTICLE_COUNT * 3);
        const colors = new Float32Array(PARTICLE_COUNT * 3);

        const color = new THREE.Color();

        for (let i = 0; i < PARTICLE_COUNT; i++) {
            positions[i * 3] = (Math.random() - 0.5) * 20;
            positions[i * 3 + 1] = (Math.random() - 0.5) * 20;
            positions[i * 3 + 2] = (Math.random() - 0.5) * 20;

            color.setHSL(Math.random(), 1, 0.6);
            colors.set([color.r, color.g, color.b], i * 3);
        }

        geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
        geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

        const material = new THREE.PointsMaterial({
            size: 0.15,
            vertexColors: true,
            transparent: true,
            blending: THREE.AdditiveBlending
        });

        const particles = new THREE.Points(geometry, material);
        scene.add(particles);

        /* ==========================================
           PARTICLE SHAPE FUNCTIONS
        ========================================== */
        function applyShape(type, scale = 8) {
            for (let i = 0; i < PARTICLE_COUNT; i++) {
                let x = 0, y = 0, z = 0;
                const t = Math.random() * Math.PI * 2;

                if (type === 'heart') {
                    x = 16 * Math.pow(Math.sin(t), 3);
                    y = 13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t);
                    z = Math.sin(t * 3) * 2;
                } else if (type === 'saturn') {
                    const r = 6 + Math.random() * 1.5;
                    x = Math.cos(t) * r;
                    z = Math.sin(t) * r;
                    y = Math.sin(i * 0.01) * 0.5;
                } else if (type === 'flower') {
                    const r = Math.sin(5 * t) * 6;
                    x = Math.cos(t) * r;
                    y = Math.sin(t) * r;
                    z = Math.cos(t * 3) * 2;
                } else if (type === 'firework') {
                    const r = Math.random() * 8;
                    const a = Math.random() * Math.PI * 2;
                    const b = Math.random() * Math.PI * 2;
                    x = r * Math.sin(a) * Math.cos(b);
                    y = r * Math.sin(a) * Math.sin(b);
                    z = r * Math.cos(a);
                }

                positions[i * 3] = x / scale;
                positions[i * 3 + 1] = y / scale;
                positions[i * 3 + 2] = z / scale;
            }
            geometry.attributes.position.needsUpdate = true;
            
            // Update shape display
            document.getElementById('shapeDisplay').value = type;
        }

        applyShape('heart');

        /* ==========================================
           HAND TRACKING SETUP
        ========================================== */
        let handX = 0.5, handY = 0.5, handOpen = 0;
        let demoMode = true;
        let currentShape = 'heart';

        const hands = new Hands({
            locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.7,
            minTrackingConfidence: 0.7
        });

        hands.onResults(results => {
            if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) return;
            
            demoMode = false;

            const landmarks = results.multiHandLandmarks[0];
            handX = landmarks[9].x;
            handY = landmarks[9].y;

            const thumb = landmarks[4];
            const index = landmarks[8];
            handOpen = Math.hypot(thumb.x - index.x, thumb.y - index.y);

            // Gesture-based shape switching
            let newShape = currentShape;
            if (handOpen > 0.15) {
                newShape = 'firework';
            } else if (handX < 0.3) {
                newShape = 'saturn';
            } else if (handX > 0.7) {
                newShape = 'flower';
            } else {
                newShape = 'heart';
            }

            if (newShape !== currentShape) {
                currentShape = newShape;
                applyShape(currentShape);
            }
        });

        async function startCamera() {
            const overlay = document.getElementById('permissionOverlay');
            const video = document.getElementById('video');
            const videoPreview = document.getElementById('video-preview');
            const modeIndicator = document.getElementById('modeIndicator');

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'user' } 
                });
                video.srcObject = stream;
                videoPreview.srcObject = stream;
                await video.play();

                const cam = new Camera(video, {
                    onFrame: async () => {
                        await hands.send({ image: video });
                    },
                    width: 640,
                    height: 480
                });
                cam.start();

                overlay.classList.add('hidden');
                videoPreview.classList.add('active');
                modeIndicator.textContent = 'üìπ Camera Active - Hand Tracking ON';
                modeIndicator.className = 'mode-indicator camera';
                demoMode = false;

            } catch (err) {
                console.warn('Camera permission denied or unavailable. Running demo mode.', err);
                overlay.classList.add('hidden');
                modeIndicator.textContent = 'üé¨ Demo Mode - Automated Animation';
                modeIndicator.className = 'mode-indicator demo';
                demoMode = true;
            }
        }

        /* ==========================================
           ANIMATION LOOP
        ========================================== */
        function animate() {
            requestAnimationFrame(animate);

            // Demo mode: Automated movement
            if (demoMode) {
                const time = Date.now();
                handX = (Math.sin(time * 0.0006) + 1) / 2;
                handY = (Math.cos(time * 0.0004) + 1) / 2;
                handOpen = (Math.sin(time * 0.001) + 1) / 4;

                // Auto shape switching in demo mode
                const shapeIndex = Math.floor((time / 3000) % 4);
                const shapes = ['heart', 'saturn', 'flower', 'firework'];
                if (shapes[shapeIndex] !== currentShape) {
                    currentShape = shapes[shapeIndex];
                    applyShape(currentShape);
                }
            }

            // Apply hand-controlled rotation
            particles.rotation.y += 0.002 + handX * 0.01;
            particles.rotation.x += 0.001 + handY * 0.01;

            // Hand-controlled size and color
            material.size = 0.1 + handOpen * 0.8;
            
            const hue = handX * 360;
            material.color = new THREE.Color(`hsl(${hue}, 100%, 70%)`);

            renderer.render(scene, camera);
        }

        animate();

        /* ==========================================
           START BUTTON EVENT
        ========================================== */
        document.getElementById('startBtn').addEventListener('click', startCamera);
    </script>
</body>
</html>
